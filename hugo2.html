<!DOCTYPE html>
<html lang='de'>
<head>
    <meta charset='utf-8' />
    <title>FullCalendar mit ICS und RRULE</title>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.2.0/ical.min.js'></script>
    <style>
        /* Basic styling */
        #calendar {
            max-width: 900px;
            margin: 40px auto;
        }
    </style>
</head>
<body>
<div id='calendar'></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');

        // ICS URL to fetch data from
        const icsUrl = "https://corsproxy.io/?https://iserv.kkg.berlin/iserv/public/calendar?key=eb329e8158c8ef6188a3cc2de8740c5b";

        // Function to parse ICS data, including RRULE
        function parseICS(data) {
            const jcalData = ICAL.parse(data);
            const comp = new ICAL.Component(jcalData);
            const events = comp.getAllSubcomponents("vevent");
            const eventList = [];

            events.forEach(event => {
                const vevent = new ICAL.Event(event);
                const rrule = vevent.component.getFirstPropertyValue('rrule');
                const startDate = vevent.startDate.toJSDate();
                const endDate = vevent.endDate.toJSDate();

                // If the event has RRULE, handle it
                if (rrule) {
                    // Handle recurrence using ical.js and expand the RRULE
                    const iterator = rrule.iterator(vevent.startDate);
                    let next;
                    while ((next = iterator.next())) {
                        // Create the event for each occurrence
                        eventList.push({
                            title: vevent.summary,
                            start: next.toJSDate(),
                            end: new Date(next.toJSDate().getTime() + (endDate - startDate)), // Calculate duration
                            allDay: vevent.startDate.isDate
                        });
                    }
                } else {
                    // Non-recurring event
                    eventList.push({
                        title: vevent.summary,
                        start: startDate,
                        end: endDate,
                        allDay: vevent.startDate.isDate
                    });
                }
            });

            return eventList;
        }

        // Fetch and load ICS data automatically on page load
        fetch(icsUrl)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.text();
            })
            .then(data => {
                const events = parseICS(data);

                // Initialize FullCalendar with parsed events
                const calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'de', // Set locale to German
                    firstDay: 1, // Week starts on Monday
                    timeZone: 'Europe/Berlin', // Ensure it follows German time zone
                    events: events,
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    eventTimeFormat: { // Set 24-hour format
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    },
                    allDayText: 'Ganztägig', // Display "Ganztägig" for all-day events
                    displayEventTime: false // Do not display time for all-day events
                });
                calendar.render();
            })
            .catch(error => console.error('Error fetching ICS file:', error));
    });
</script>
</body>
</html>

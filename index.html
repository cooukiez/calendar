<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <title>Schulkalender</title>

    <link rel="stylesheet" href="global.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@event-calendar/build@3.6.1/event-calendar.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@event-calendar/build@3.6.1/event-calendar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.0.0/ical.min.js"></script>

</head>

<body>

<header class="row">
    <button class="toggle-dark-button" title="Toggle dark mode" onclick="document.body.classList.toggle('ec-dark')">
        <svg class="light" focusable="false" viewBox="0 0 32 32">
            <path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z"
                  fill="currentColor"></path>
            <path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path>
            <path d="M2 15.005h5v2H2z" fill="currentColor"></path>
            <path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path>
            <path d="M15 25.005h2v5h-2z" fill="currentColor"></path>
            <path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path>
            <path d="M25 15.005h5v2h-5z" fill="currentColor"></path>
            <path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path>
            <path d="M15 2.005h2v5h-2z" fill="currentColor"></path>
        </svg>
        <svg class="dark" focusable="false" viewBox="0 0 32 32">
            <path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z"
                  fill="currentColor"></path>
        </svg>
    </button>
</header>
<main class="row">
    <div id="ec" class="col"></div>
</main>

<script type="text/javascript">
    const corsProxy = 'https://corsproxy.io/?';
    const icsUrl = 'https://iserv.kkg.berlin/iserv/public/calendar?key=eb329e8158c8ef6188a3cc2de8740c5b'; // Replace with your ICS feed URL

    const fetchICS = async (url) => {
        try {
            const response = await fetch(corsProxy + url); // Prepend CORS proxy
            if (!response.ok) {
                throw new Error("Failed to fetch the .ics file");
            }
            return await response.text();
        } catch (error) {
            console.error("Error fetching the .ics file:", error);
        }
    };

    const parseICS = (icsData) => {
        const jcalData = ICAL.parse(icsData);
        const comp = new ICAL.Component(jcalData);
        const events = comp.getAllSubcomponents("vevent");
        const eventList = [];

        events.forEach(event => {
            const vevent = new ICAL.Event(event);
            eventList.push({
                summary: vevent.summary,
                startDate: vevent.startDate.toJSDate(),
                endDate: vevent.endDate.toJSDate(),
                rrule: vevent.rrule,
            });
        });

        return eventList;
    };

    // Fetch and parse the ICS data
    fetchICS(icsUrl).then(icsData => {
        const events = parseICS(icsData);
        console.log(events);

        // Initialize the Event Calendar after the events have been fetched
        const ec = new EventCalendar(document.getElementById('ec'), {
            locale: 'de',

            view: 'dayGridMonth',
            headerToolbar: {
                start: 'prev,next today',
                center: 'title',
                end: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            scrollTime: '09:00:00', // Todo: current time
            events: events.map(event => ({
                title: event.summary,
                start: event.startDate.toISOString(), // Use ISO string for the start time
                end: event.endDate.toISOString(), // Use ISO string for the end time
                content: event.summary,
            })),
            views: {
                timeGridWeek: {
                    pointer: true,
                    slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false }, // 24h time format
                },
                resourceTimeGridWeek: { pointer: true },
            },

            dayMaxEvents: true,
            nowIndicator: true,

            firstDay: 1, // Monday

            eventStartEditable: false, // Disable editing the start time
            eventDurationEditable: false, // Disable editing the duration
        });
    });

    function _pad(num) {
        let norm = Math.floor(Math.abs(num));
        return (norm < 10 ? '0' : '') + norm;
    }
</script>
</body>
</html>
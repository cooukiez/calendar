<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <title>Schulkalender</title>

    <!-- Critical CSS first -->
    <link rel="stylesheet" href="global.css">

    <!-- Load external CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@event-calendar/build@3.6.1/event-calendar.min.css">

    <!-- Load scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.2.0/ical.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@event-calendar/build@3.6.1/event-calendar.min.js" defer></script>
</head>

<body>
<header class="row">
    <button class="toggle-dark-button" title="Toggle dark mode" onclick="document.body.classList.toggle('ec-dark')">
        <svg class="light" focusable="false" viewBox="0 0 32 32">
            <path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z"
                  fill="currentColor"></path>
            <path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path>
            <path d="M2 15.005h5v2H2z" fill="currentColor"></path>
            <path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path>
            <path d="M15 25.005h2v5h-2z" fill="currentColor"></path>
            <path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path>
            <path d="M25 15.005h5v2h-5z" fill="currentColor"></path>
            <path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path>
            <path d="M15 2.005h2v5h-2z" fill="currentColor"></path>
        </svg>
        <svg class="dark" focusable="false" viewBox="0 0 32 32">
            <path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z"
                  fill="currentColor"></path>
        </svg>
    </button>
</header>
<main class="<script>0</script>row">
    <div id="ec" class="col"></div>
</main>

<script type="text/javascript">
    // Function to toggle dark mode based on system theme
    function setSystemTheme() {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('ec-dark');
        } else {
            document.body.classList.remove('ec-dark');
        }
    }

    // Call the function when the page loads
    window.addEventListener('load', setSystemTheme);

    // Listen for changes in the system theme
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', setSystemTheme);

    const corsProxy = 'https://corsproxy.io/?';
    const icsUrl = 'https://iserv.kkg.berlin/iserv/public/calendar?key=eb329e8158c8ef6188a3cc2de8740c5b'; // Replace with your ICS feed URL
    const currentDate = new Date();
    let key;

    const fetchICS = async (url) => {
        try {
            const response = await fetch(corsProxy + url); // Prepend CORS proxy
            if (!response.ok) {
                throw new Error("Failed to fetch the .ics file");
            }
            return await response.text();
        } catch (error) {
            console.error("Error fetching the .ics file:", error);
        }
    };

    const parseICS = (icsData) => {
        const jcalData = ICAL.parse(icsData);
        const comp = new ICAL.Component(jcalData);
        const events = comp.getAllSubcomponents("vevent");
        const eventList = [];

        events.forEach(event => {
            const vevent = new ICAL.Event(event);
            const rrule = vevent.component.getFirstPropertyValue('rrule');
            const startDate = vevent.startDate.toJSDate();
            const endDate = vevent.endDate.toJSDate();
            const location = vevent.component.getFirstPropertyValue('location');
            const category = vevent.component.getFirstPropertyValue('categories');

            if (rrule) {
                // Handle recurrence using ical.js and expand the RRULE
                const iterator = rrule.iterator(vevent.startDate);

                let next; // next date for the event
                while ((next = iterator.next())) {
                    const nextEndDate = new Date(next.toJSDate().getTime() + (endDate - startDate)); // Calculate duration

                    // Create the event for each occurrence
                    eventList.push({
                        summary: vevent.summary,
                        startDate: next.toJSDate(),
                        endDate: nextEndDate,
                        allDay: vevent.startDate.isDate,
                        description: vevent.description,
                        category: category,
                        location: location,
                        pastDate: nextEndDate < currentDate,
                    });
                }
            } else {
                // Non-recurring event
                eventList.push({
                    summary: vevent.summary,
                    startDate: vevent.startDate.toJSDate(),
                    endDate: vevent.endDate.toJSDate(),
                    allDay: vevent.startDate.isDate,
                    description: vevent.description,
                    category: category,
                    location: location,
                    pastDate: vevent.endDate.toJSDate() < currentDate,
                });
            }
        });

        return eventList;
    };

    function getHiddenAmountBottom(scrollView, element) {
        const scrollViewRect = scrollView.getBoundingClientRect();
        const elementRect = element.getBoundingClientRect();

        // Calculate the bottom of the scroll view and the element
        const scrollViewBottom = scrollViewRect.bottom;
        const elementBottom = elementRect.bottom;

        // Calculate the hidden amount
        return Math.max(0, elementBottom - scrollViewBottom);
    }

    function getHiddenAmountLeft(scrollView, element) {
        const scrollViewRect = scrollView.getBoundingClientRect();
        const elementRect = element.getBoundingClientRect();

        // Calculate the right edge of the scroll view and the element
        const scrollViewLeft = scrollViewRect.left;
        const elementLeft = elementRect.left;

        // Calculate the hidden amount
        return Math.min(0, elementLeft - scrollViewLeft);
    }

    // Create a new div element for the event details box and append it to the body (once)
    const detailsBox = document.createElement('div');
    detailsBox.id = 'event-details-box';
    detailsBox.classList.add('event-details-box');
    detailsBox.style.display = 'none'; // Initially hidden
    document.body.appendChild(detailsBox);

    // Fetch and parse the ICS data
    fetchICS(icsUrl).then(icsData => {
        const events = parseICS(icsData);

        const mCategories = new Map([
            ['Klausur', '#800080'],
            ['Wichtig', '#b32f28'],
            ['Ferien', '#2E8B57'],
            ['Veranstaltung', '#a29417'],
            ['Saufen', '#B22222'],
        ]);
        mCategories.set(null, '#4682B4');
        const today = new Date();

        // Initialize the Event Calendar after the events have been fetched
        const ec = new EventCalendar(document.getElementById('ec'), {
            locale: 'de',

            view: 'dayGridMonth',

            headerToolbar: {
                start: 'prev,next today',
                center: 'title',
                end: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek Filter'
                end: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek,resourceTimelineWeek'
            },
            scrollTime: currentDate.getHours() + ":" + currentDate.getMinutes() + ":" + currentDate.getSeconds(), // Todo: current time
            resources: [
                {id: 1, title: 'KKG'}
            ],
            events: events.map(event => ({
                title: event.summary,
                start: event.startDate,
                end: event.endDate,
                allDay: event.allDay,
                extendedProps: {
                    description: event.description,
                    location: event.location,
                    category: event.category,
                },
                id: event.category,
                color: mCategories.get(event.category),
                className: event.pastDate ? 'ec-past-event' : '',
                resourceId: 1,
            })),

            customButtons: {
                Filter: {
                    text: 'Filter',
                    click: function (event) {
                        let dropdown = document.getElementById('dropdown');
                        if (!dropdown) {

                            dropdown = document.createElement('div');
                            dropdown.id = 'dropdown';
                            for (const ckey of mCategories.keys()) {
                                if (ckey !== null) {
                                    const button = document.createElement('button');
                                    button.id = ckey;
                                    button.textContent = ckey;
                                    button.classList.add('dropbtn');
                                    dropdown.appendChild(button);
                                    const lineBreak1 = document.createElement('br');
                                    dropdown.appendChild(lineBreak1);
                                }
                            }
                            dropdown.classList.add('dropdown');

                            document.body.appendChild(dropdown);
                            const dropdownWidth = dropdown.offsetWidth;
                            const buttonPosition = event.target.getBoundingClientRect();

                            dropdown.style.top = `${buttonPosition.bottom + window.scrollY}px`; // Align bottom (consider scroll)
                            dropdown.style.left = `${buttonPosition.right - dropdownWidth + window.scrollX}px`;

                            document.addEventListener('click', function outsideClickListener(e) {
                                console.log(mCategories.has(e.target.id))
                                if (mCategories.has(e.target.id)) {
                                    for (const pkey of mCategories.keys()) {
                                        if(pkey === e.target.id) {
                                            events.forEach(event => {
                                                if (event.category === pkey) {
                                                    event.className = 'invis';
                                                    ec.updateEvent(event);
                                                }
                                            });
                                        }
                                    }
                                }
                                console.log(events)
                                if (!dropdown.contains(e.target) && e.target !== event.target) {
                                    dropdown.remove();
                                    document.removeEventListener('click', outsideClickListener);
                                }
                            });
                        } else {
                            dropdown.remove();
                        }
                    }
                }
            },

            allDayContent: 'Ganztägig',

            buttonText: {
                listWeek: 'Übersicht',
                dayGridMonth: 'Monat',
                timeGridWeek: 'Woche',
                timeGridDay: 'Tag',
                today: 'Heute',
                resourceTimelineWeek: 'Timeline',
            },

            views: {
                timeGridWeek: {
                    pointer: true,
                    slotLabelFormat: {hour: '2-digit', minute: '2-digit', hour12: false}, // 24h time format
                },
                resourceTimeGridWeek: {pointer: true},
                //slotWidth: 100,
            },

            slotEventOverlap: false,
            dayMaxEvents: true,
            nowIndicator: true,

            firstDay: 1, // Monday

            eventStartEditable: false, // Disable editing the start time
            eventDurationEditable: false, // Disable editing the duration

            eventClick: function (info) {
                alert(info.event.title + ' clicked.');
            },

            eventMouseEnter: function (info) {
                const event = info.event;
                const eventElement = info.el;

                detailsBox.innerHTML = `
                    <div class="title">${event.title}</div>
                    <div style="width: 100%">
                    <div class="desc">${event.extendedProps.description || ''}</div>
                    <div class="subtext">
                        ${event.extendedProps.location ? '<span class="nerd-icon">\uf450 </span>' + event.extendedProps.location + '<br>' : ''}
                        ${event.extendedProps.category ? '<span class="nerd-icon">\uea83 </span>' + event.extendedProps.category + '<br>' : ''}
                        ${event.start.toLocaleString()}
                    </div>
                    </div>
                `;

                let windowScrollY = document.documentElement.scrollTop;
                const scrollContainer = document.querySelector('.ec-body');

                function updatePosition() {
                    let rect = eventElement.getBoundingClientRect();
                    let containerRect = scrollContainer.getBoundingClientRect();

                    windowScrollY = document.documentElement.scrollTop;

                    const hiddenAmountBottom = getHiddenAmountBottom(scrollContainer, eventElement);
                    const hiddenAmountLeft = getHiddenAmountLeft(scrollContainer, eventElement);

                    if (hiddenAmountBottom > 0) {
                        detailsBox.style.top = `${containerRect.bottom}px`;
                    } else {
                        detailsBox.style.top = `${rect.bottom + windowScrollY}px`;
                    }

                    if (hiddenAmountLeft < 0) {
                        detailsBox.style.left = `${containerRect.left}px`;
                    } else {
                        detailsBox.style.left = `${rect.left}px`;
                    }
                }

                updatePosition();
                detailsBox.style.display = 'block';

                document.addEventListener('scroll', function () {
                    updatePosition();
                }, {passive: true});

                scrollContainer.addEventListener('scroll', function () {
                    updatePosition();
                }, {passive: true});
            },

            eventMouseLeave: function() {
                detailsBox.style.display = 'none';
            },
        });
    });

</script>
</body>
</html>